# خطة إعادة هيكلة وإعادة كتابة الكود

## مقدمة

بناءً على التحليل الشامل لهيكل المشروع والتكامل بين وحداته المختلفة، تم وضع خطة لإعادة هيكلة المشروع وإعادة كتابة الأجزاء الحرجة. تهدف هذه الخطة إلى معالجة المشاكل المحددة وتحسين جودة الكود وقابليته للصيانة والتوسع.

## الأهداف الرئيسية

1. **تبسيط هيكل المشروع**: دمج الوحدات المتداخلة وإزالة التكرار
2. **تحسين التكامل**: إنشاء طبقة وسيطة للتكامل بين الوحدات المختلفة
3. **تعزيز الموثوقية**: تحسين آليات التتبع والتحقق من صحة البيانات
4. **تحسين الأداء**: تحسين استعلامات قاعدة البيانات وتنفيذ التخزين المؤقت
5. **تعزيز الأمان**: تحسين التحقق من المدخلات وإدارة الصلاحيات

## خطة إعادة الهيكلة

### المرحلة 1: إعادة تنظيم هيكل المجلدات والملفات

#### 1.1 دمج وحدات المحاسبة

**الوضع الحالي**: وجود مجلدين منفصلين `accounting` و `accounts` مع تداخل في المسؤوليات.

**الإجراءات المقترحة**:
- إنشاء مجلد موحد `finance` يحتوي على:
  - `finance/accounts`: لإدارة دليل الحسابات
  - `finance/journal`: لإدارة القيود المحاسبية
  - `finance/reports`: للتقارير المالية
  - `finance/inventory`: للتكامل مع المخزون
- نقل الوظائف من المجلدين القديمين إلى الهيكل الجديد
- تحديث جميع الاستدعاءات في النظام

**الملفات المتأثرة**:
- جميع الملفات في `controller/accounting/` و `controller/accounts/`
- جميع الملفات في `model/accounting/` و `model/accounts/`
- جميع الملفات في `view/template/accounting/` و `view/template/accounts/`
- ملفات اللغة المرتبطة

#### 1.2 إعادة تنظيم نظام الإشعارات

**الوضع الحالي**: تداخل بين `model/notification/` و `model/common/notification.php`.

**الإجراءات المقترحة**:
- إنشاء مجلد موحد `notification` يحتوي على:
  - `notification/manager.php`: لإدارة الإشعارات
  - `notification/types/`: لأنواع الإشعارات المختلفة
  - `notification/templates/`: لقوالب الإشعارات
- تنفيذ واجهة برمجة موحدة للإشعارات
- تحديث جميع استدعاءات الإشعارات في النظام

**الملفات المتأثرة**:
- `model/notification/`
- `model/common/notification.php`
- `controller/common/notification.php`
- `view/template/common/notification_center.twig`

#### 1.3 توحيد نظام السجلات

**الوضع الحالي**: وجود عدة أنظمة للسجلات (`audit_log`, `activity`).

**الإجراءات المقترحة**:
- إنشاء مجلد موحد `logging` يحتوي على:
  - `logging/manager.php`: لإدارة السجلات
  - `logging/types/`: لأنواع السجلات المختلفة
  - `logging/reports/`: لتقارير السجلات
- تنفيذ واجهة برمجة موحدة للسجلات
- تحديث جميع استدعاءات السجلات في النظام

**الملفات المتأثرة**:
- `model/tool/audit_log.php`
- `model/user/activity.php`
- الملفات المرتبطة بعرض وإدارة السجلات

### المرحلة 2: إنشاء طبقة وسيطة للتكامل

#### 2.1 تصميم وتنفيذ طبقة التكامل

**الإجراءات المقترحة**:
- إنشاء مجلد `integration` يحتوي على:
  - `integration/manager.php`: لإدارة التكامل
  - `integration/inventory_finance.php`: للتكامل بين المخزون والحسابات
  - `integration/notification_service.php`: لخدمة الإشعارات
  - `integration/logging_service.php`: لخدمة السجلات
  - `integration/transaction.php`: لإدارة المعاملات المتكاملة
- تنفيذ نظام أحداث (Event System) لإطلاق الإشعارات والسجلات

**الملفات الجديدة**:
- `model/integration/manager.php`
- `model/integration/inventory_finance.php`
- `model/integration/notification_service.php`
- `model/integration/logging_service.php`
- `model/integration/transaction.php`

#### 2.2 تحديث الوحدات الرئيسية لاستخدام طبقة التكامل

**الإجراءات المقترحة**:
- تحديث وحدة المخزون لاستخدام طبقة التكامل
- تحديث وحدة الحسابات لاستخدام طبقة التكامل
- تحديث وحدة المبيعات والمشتريات لاستخدام طبقة التكامل

**الملفات المتأثرة**:
- `model/catalog/product.php`
- `model/inventory/inventory_manager.php`
- `model/finance/journal.php` (بعد إعادة التسمية)
- `model/sale/order.php`
- `model/purchase/purchase_order.php`

### المرحلة 3: تحسين آلية تتبع العمليات

#### 3.1 تنفيذ نظام معرفات العمليات

**الإجراءات المقترحة**:
- إنشاء نظام لإنشاء وتتبع معرفات فريدة للعمليات
- تحديث جداول قاعدة البيانات لتخزين معرفات العمليات
- تنفيذ واجهة لتتبع العمليات

**الملفات الجديدة**:
- `model/integration/transaction_id.php`
- `controller/tool/transaction_tracker.php`
- `view/template/tool/transaction_tracker.twig`

#### 3.2 تحديث العمليات الرئيسية لاستخدام نظام المعرفات

**الإجراءات المقترحة**:
- تحديث عمليات البيع لاستخدام معرفات العمليات
- تحديث عمليات الشراء لاستخدام معرفات العمليات
- تحديث عمليات المخزون لاستخدام معرفات العمليات
- تحديث عمليات الحسابات لاستخدام معرفات العمليات

**الملفات المتأثرة**:
- جميع الملفات التي تتعامل مع العمليات الرئيسية

### المرحلة 4: تحسين آلية حساب المتوسط المرجح للتكلفة

#### 4.1 إعادة تصميم آلية حساب التكلفة

**الإجراءات المقترحة**:
- تصميم آلية أكثر دقة لحساب المتوسط المرجح للتكلفة
- تنفيذ تتبع أفضل لتكلفة المشتريات
- تنفيذ آلية لمراعاة تحويلات المخزون في حساب التكلفة
- تنفيذ تاريخ كامل لتغيرات التكلفة

**الملفات الجديدة**:
- `model/inventory/cost_calculator.php`
- `model/inventory/cost_history.php`

**الملفات المتأثرة**:
- `model/catalog/product.php`
- `model/inventory/inventory_manager.php`

#### 4.2 تحديث التقارير المرتبطة بالتكلفة

**الإجراءات المقترحة**:
- تحديث تقارير تقييم المخزون
- تحديث تقارير تكلفة البضاعة المباعة
- إنشاء تقارير جديدة لتحليل تغيرات التكلفة

**الملفات المتأثرة**:
- `model/report/inventory.php`
- `controller/report/inventory_valuation.php`
- `view/template/report/inventory_valuation.twig`

### المرحلة 5: استكمال الوحدات غير المكتملة

#### 5.1 استكمال وحدة المستندات

**الإجراءات المقترحة**:
- تصميم وتنفيذ هيكل كامل لوحدة المستندات
- إنشاء الملفات الناقصة (Controllers, Views, Language files)
- تكامل وحدة المستندات مع بقية النظام

**الملفات الجديدة**:
- `controller/document/`
- `view/template/document/`
- ملفات اللغة المرتبطة

#### 5.2 تحسين وحدة سير العمل

**الإجراءات المقترحة**:
- مراجعة وتحسين وحدة سير العمل
- تكامل أفضل مع بقية النظام
- تحسين واجهة المستخدم

**الملفات المتأثرة**:
- `controller/workflow/`
- `model/workflow/`
- `view/template/workflow/`

### المرحلة 6: تحسين الأداء والأمان

#### 6.1 تحسين استعلامات قاعدة البيانات

**الإجراءات المقترحة**:
- مراجعة وتحسين استعلامات قاعدة البيانات الحرجة
- تنفيذ التخزين المؤقت للبيانات المتكررة
- تحسين أداء صفحات المنتجات والفئات

**الملفات المتأثرة**:
- جميع الملفات التي تحتوي على استعلامات معقدة

#### 6.2 تعزيز الأمان

**الإجراءات المقترحة**:
- تحسين التحقق من المدخلات
- تنفيذ حماية CSRF لجميع النماذج
- تحسين إدارة الصلاحيات والأذونات

**الملفات المتأثرة**:
- جميع الملفات التي تتعامل مع مدخلات المستخدم
- ملفات إدارة الصلاحيات

## خطة التنفيذ

### جدول زمني مقترح

1. **المرحلة 1: إعادة تنظيم هيكل المجلدات والملفات** (2-3 أسابيع)
   - الأسبوع 1: دمج وحدات المحاسبة
   - الأسبوع 2: إعادة تنظيم نظام الإشعارات
   - الأسبوع 3: توحيد نظام السجلات

2. **المرحلة 2: إنشاء طبقة وسيطة للتكامل** (3-4 أسابيع)
   - الأسبوع 1-2: تصميم وتنفيذ طبقة التكامل
   - الأسبوع 3-4: تحديث الوحدات الرئيسية لاستخدام طبقة التكامل

3. **المرحلة 3: تحسين آلية تتبع العمليات** (2-3 أسابيع)
   - الأسبوع 1: تنفيذ نظام معرفات العمليات
   - الأسبوع 2-3: تحديث العمليات الرئيسية لاستخدام نظام المعرفات

4. **المرحلة 4: تحسين آلية حساب المتوسط المرجح للتكلفة** (2-3 أسابيع)
   - الأسبوع 1-2: إعادة تصميم آلية حساب التكلفة
   - الأسبوع 3: تحديث التقارير المرتبطة بالتكلفة

5. **المرحلة 5: استكمال الوحدات غير المكتملة** (3-4 أسابيع)
   - الأسبوع 1-2: استكمال وحدة المستندات
   - الأسبوع 3-4: تحسين وحدة سير العمل

6. **المرحلة 6: تحسين الأداء والأمان** (2-3 أسابيع)
   - الأسبوع 1-2: تحسين استعلامات قاعدة البيانات
   - الأسبوع 3: تعزيز الأمان

### منهجية التنفيذ

1. **التطوير التدريجي**: تنفيذ التغييرات بشكل تدريجي لتقليل المخاطر
2. **الاختبار المستمر**: اختبار كل تغيير بشكل شامل قبل الانتقال للخطوة التالية
3. **التوثيق**: توثيق جميع التغييرات والتحسينات
4. **النسخ الاحتياطية**: الحفاظ على نسخ احتياطية منتظمة أثناء عملية التطوير

## الفوائد المتوقعة

1. **تحسين جودة الكود**: كود أكثر تنظيماً وقابلية للصيانة
2. **تعزيز الموثوقية**: تقليل الأخطاء وتحسين تتبع العمليات
3. **تحسين الأداء**: استجابة أسرع وكفاءة أعلى
4. **تعزيز الأمان**: حماية أفضل للبيانات والعمليات
5. **تسهيل التوسع**: قابلية أفضل لإضافة ميزات جديدة

## الخلاصة

تقدم هذه الخطة إطاراً شاملاً لإعادة هيكلة المشروع وتحسين جودته. التنفيذ التدريجي والاختبار المستمر سيضمنان نجاح عملية التطوير وتقليل المخاطر. النتيجة النهائية ستكون نظاماً أكثر استقراراً وقابلية للصيانة والتوسع، مما سيوفر قيمة أكبر للمستخدمين والعملاء.
